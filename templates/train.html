{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-cards text-primary"></i> Poker Training Scenario
                    </h5>
                    
                    <div id="scenario-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading scenario...</p>
                        </div>
                    </div>
                    
                    <div id="scenario-content" style="display: none;">
                        <div class="scenario-card">
                            <p id="scenario-text"></p>
                        </div>
                        
                        <div class="answer-section">
                            <h6>What is your decision?</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary answer-btn" data-answer="fold">
                                            <i class="fas fa-times"></i> Fold
                                        </button>
                                        <button class="btn btn-outline-primary answer-btn" data-answer="call">
                                            <i class="fas fa-check"></i> Call
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary answer-btn" data-answer="raise">
                                            <i class="fas fa-arrow-up"></i> Raise
                                        </button>
                                        <button class="btn btn-outline-primary answer-btn" data-answer="check">
                                            <i class="fas fa-hand-paper"></i> Check
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary answer-btn" data-answer="bet">
                                        <i class="fas fa-coins"></i> Bet
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="feedback" class="feedback" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-line text-primary"></i> Your Statistics
                    </h5>
                    <div id="stats-container">
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 id="correct-count">0</h4>
                                <small class="text-muted">Correct</small>
                            </div>
                            <div class="col-4">
                                <h4 id="total-count">0</h4>
                                <small class="text-muted">Total</small>
                            </div>
                            <div class="col-4">
                                <h4 id="accuracy">0%</h4>
                                <small class="text-muted">Accuracy</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-danger btn-sm" onclick="resetStats()">
                            <i class="fas fa-redo"></i> Reset Stats
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-cog text-primary"></i> Training Options
                    </h5>
                    <div class="mb-3">
                        <label class="form-label">Scenario Type</label>
                        <select class="form-select" id="scenario-type">
                            <option value="mixed">Mixed (Pre-flop & Post-flop)</option>
                            <option value="preflop">Pre-flop Only</option>
                            <option value="postflop">Post-flop Only</option>
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="loadNewScenario()">
                            <i class="fas fa-refresh"></i> New Scenario
                        </button>
                        <button class="btn btn-outline-primary" onclick="skipScenario()">
                            <i class="fas fa-forward"></i> Skip
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadNewScenario();
      bindAnswerButtons();
    });
    
    let currentScenarioId = null;
    let answeredCurrent   = false;
    
    function bindAnswerButtons() {
      document.querySelectorAll('.answer-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          submitAnswer(btn.dataset.answer);
        });
      });
    }
    
    function loadNewScenario() {
      // Reset UI
      answeredCurrent = false;
      document.getElementById('feedback').style.display = 'none';
      document.getElementById('scenario-container').style.display = 'block';
      document.getElementById('scenario-content').style.display   = 'none';
    
      // Reset button styles
      document.querySelectorAll('.answer-btn').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('btn-success', 'btn-danger');
        btn.classList.add('btn-outline-primary');
      });
    
      const type = document.getElementById('scenario-type').value;
      axios.get('/api/scenario', { params: { type } })
        .then(({ data }) => {
          currentScenarioId = data.scenario_id;
          document.getElementById('scenario-text').textContent = data.instruction;
          document.getElementById('scenario-container').style.display = 'none';
          document.getElementById('scenario-content').style.display   = 'block';
        })
        .catch(err => {
          console.error(err);
          document.getElementById('scenario-container').innerHTML =
            '<div class="alert alert-danger">Failed to load scenario.</div>';
        });
    }
    
    function submitAnswer(answer) {
      if (answeredCurrent) return;
      answeredCurrent = true;
    
      axios.post('/api/check-answer', {
        scenario_id: currentScenarioId,
        answer
      })
      .then(({ data }) => {
        const { correct, correct_answer, explanation } = data;
        saveResult(correct);
        showFeedback(correct, correct_answer, explanation);
        updateAnswerButtons(answer, correct_answer);
        loadStats();
      })
      .catch(err => {
        console.error(err);
        showFeedback(false, 'Error', 'Could not check answer.');
      });
    }
    
    function showFeedback(isCorrect, correctAnswer, explanation) {
      const fb = document.getElementById('feedback');
      fb.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
      fb.innerHTML = isCorrect
        ? `<i class="fas fa-check-circle"></i> Correct!<br><small>${explanation}</small>`
        : `<i class="fas fa-times-circle"></i> Incorrect. Correct: <strong>${correctAnswer}</strong><br><small>${explanation}</small>`;
      fb.style.display = 'block';
    }
    
    function updateAnswerButtons(userAnswer, correctAnswer) {
      document.querySelectorAll('.answer-btn').forEach(btn => {
        btn.disabled = true;
        if (btn.dataset.answer === userAnswer) {
          btn.classList.remove('btn-outline-primary');
          btn.classList.add(userAnswer === correctAnswer ? 'btn-success' : 'btn-danger');
        }
        if (btn.dataset.answer === correctAnswer && userAnswer !== correctAnswer) {
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-success');
        }
      });
    }
    
    function skipScenario() {
      loadNewScenario();
    }
    
    function loadStats() {
      const correct = +localStorage.getItem('correctCount') || 0;
      const total   = +localStorage.getItem('totalCount')   || 0;
      const acc     = total > 0 ? Math.round((correct / total) * 100) : 0;
      document.getElementById('correct-count').textContent = correct;
      document.getElementById('total-count').textContent   = total;
      document.getElementById('accuracy').textContent      = `${acc}%`;
    }
    
    function saveResult(wasCorrect) {
      const correct = (+localStorage.getItem('correctCount') || 0) + (wasCorrect ? 1 : 0);
      const total   = (+localStorage.getItem('totalCount')   || 0) + 1;
      localStorage.setItem('correctCount', correct);
      localStorage.setItem('totalCount', total);
    }
    
    function resetStats() {
      localStorage.removeItem('correctCount');
      localStorage.removeItem('totalCount');
      loadStats();
    }
</script>
{% endblock %}