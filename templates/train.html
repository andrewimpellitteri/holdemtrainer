{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-spade"></i> Poker Training Scenario
                    </h5>
                </div>
                <div class="card-body">
                    <div id="scenario-container">
                        <div class="d-flex justify-content-center align-items-center my-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="ms-3 mb-0">Loading your next scenario...</p>
                        </div>
                    </div>
                    
                    <div id="scenario-content" style="display: none;">
                        <!-- Scenario details will be injected here -->
                    </div>

                    <div id="answer-buttons" class="mt-4"> 
                        <!-- Dynamic buttons go here -->
                    </div>

                    <div id="feedback" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-line text-primary"></i> Your Statistics
                    </h5>
                    <div id="stats-container" class="text-center">
                        <div class="row">
                            <div class="col">
                                <h3 id="correct-count" class="mb-0">0</h3>
                                <small class="text-muted">Correct</small>
                            </div>
                            <div class="col">
                                <h3 id="total-count" class="mb-0">0</h3>
                                <small class="text-muted">Total</small>
                            </div>
                            <div class="col">
                                <h3 id="accuracy" class="mb-0">0%</h3>
                                <small class="text-muted">Accuracy</small>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid mt-3">
                        <button class="btn btn-outline-danger btn-sm" onclick="resetStats()">
                            <i class="fas fa-redo"></i> Reset Stats
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-cog text-primary"></i> Training Options
                    </h5>
                    <div class="mb-3">
                        <label for="scenario-type" class="form-label">Scenario Type</label>
                        <select class="form-select" id="scenario-type">
                            <option value="mixed">Mixed (Pre & Post-flop)</option>
                            <option value="preflop">Pre-flop Only</option>
                            <option value="postflop">Post-flop Only</option>
                        </select>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="loadNewScenario()">
                            <i class="fas fa-sync-alt"></i> New Scenario
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentScenarioId = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadNewScenario();
    });

    function renderScenario(scenario) {
        const container = document.getElementById('scenario-content');
        let html = `<h5>Your Hand: <span class="badge bg-secondary">${scenario.hand}</span></h5>`;

        html += `<ul class="list-group list-group-flush">`;
        if (scenario.type === 'preflop') {
            html += `<li class="list-group-item"><strong>Position:</strong> ${scenario.position}</li>`;
            html += `<li class="list-group-item"><strong>Pre-flop History:</strong> ${scenario.preflop_history}</li>`;
            html += `<li class="list-group-item"><strong>Pot Size:</strong> ${scenario.pot_size}</li>`;
        } else {
            html += `<li class="list-group-item"><strong>Position:</strong> ${scenario.position}</li>`;
            html += `<li class="list-group-item"><strong>Board:</strong> <span class="font-monospace">${scenario.board}</span></li>`;
            html += `<li class="list-group-item"><strong>Pot Size:</strong> ${scenario.pot_size}</li>`;
            html += `<li class="list-group-item"><strong>Pre-flop Action:</strong> ${scenario.preflop_action}</li>`;
            html += `<li class="list-group-item"><strong>Post-flop Action:</strong> ${scenario.postflop_action}</li>`;
        }
        html += `</ul>`;
        container.innerHTML = html;
    }

    function renderAnswerButtons(moves) {
        const container = document.getElementById('answer-buttons');
        container.innerHTML = '';
        const buttonGrid = document.createElement('div');
        buttonGrid.className = 'd-grid gap-2';

        moves.forEach(move => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-primary answer-btn';
            button.dataset.answer = move.toLowerCase();
            button.textContent = move;
            button.onclick = () => submitAnswer(move.toLowerCase());
            buttonGrid.appendChild(button);
        });
        container.appendChild(buttonGrid);
    }

    function loadNewScenario() {
        document.getElementById('scenario-container').style.display = 'block';
        document.getElementById('scenario-content').style.display = 'none';
        document.getElementById('answer-buttons').innerHTML = '';
        document.getElementById('feedback').style.display = 'none';

        const type = document.getElementById('scenario-type').value;
        axios.get(`/api/scenario?type=${type}`)
            .then(({ data }) => {
                currentScenarioId = data.scenario_id;
                renderScenario(data);
                renderAnswerButtons(data.available_moves);
                document.getElementById('scenario-container').style.display = 'none';
                document.getElementById('scenario-content').style.display = 'block';
            })
            .catch(err => {
                console.error("Failed to load scenario:", err);
                const container = document.getElementById('scenario-container');
                container.innerHTML = `<div class="alert alert-danger">Error loading scenario. Please try again.</div>`;
            });
    }

    function submitAnswer(answer) {
        axios.post('/api/check-answer', { scenario_id: currentScenarioId, answer })
            .then(({ data }) => {
                updateUIAfterAnswer(answer, data.correct, data.correct_answer);
                updateSessionStats(data.correct);
            })
            .catch(err => {
                console.error("Error checking answer:", err);
                showFeedback(false, 'Error', 'Could not verify your answer.');
            });
    }

    function updateUIAfterAnswer(userAnswer, isCorrect, correctAnswer) {
        document.querySelectorAll('.answer-btn').forEach(btn => {
            btn.disabled = true;
            const btnAnswer = btn.dataset.answer;
            if (btnAnswer === correctAnswer.toLowerCase()) {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');
            }
            if (btnAnswer === userAnswer && !isCorrect) {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-danger');
            }
        });
        showFeedback(isCorrect, correctAnswer);
    }

    function showFeedback(isCorrect, correctAnswer) {
        const feedbackEl = document.getElementById('feedback');
        if (isCorrect) {
            feedbackEl.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> Correct! The optimal move was <strong>${correctAnswer}</strong>.</div>`;
        } else {
            feedbackEl.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Incorrect. The correct move was <strong>${correctAnswer}</strong>.</div>`;
        }
        feedbackEl.style.display = 'block';
    }

    function updateSessionStats(isCorrect) {
        axios.get('/api/stats').then(({ data }) => {
            document.getElementById('correct-count').textContent = data.correct;
            document.getElementById('total-count').textContent = data.total;
            document.getElementById('accuracy').textContent = `${data.accuracy}%`;
        });
    }

    function resetStats() {
        axios.post('/api/reset-stats').then(() => {
            updateSessionStats(); // Refresh stats display
        });
    }

    function loadStats() {
        updateSessionStats();
    }

</script>
{% endblock %}